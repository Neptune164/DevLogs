# 开发日志

## 日期
2025-08-22

## 今日目标
- [x] 重命名项目为“TranslatorShell”
- [x] 完成对聊天事件的重复，并打印到游戏内聊天框
- [x] 完成浮窗显示文字模块，且浮窗可拖拽、缩放
- [x] 完成了翻译模块，留下AI API的调用接口
- [x] 修复了浮窗无法正常显示中文的问题
- [x] 初步完成翻译模块的异步并行逻辑
- [x] 完成最小可运行版本


## 开发内容
### 模块/功能点
- **名称**: TranslationOverlay
- **描述**: 控制浮窗逻辑的类，定义翻译后文字在浮窗的显示效果

- **名称**: TranslatorClient
- **描述**: 控制调用AI API的接口（目前暂定使用旧版Google Translation的Web接口，返回JSON数据）

### 遇到的问题
1. 问题现象：重命名namespace和解决方案后Dalamud插件选择界面不出现插件  
   初步推测：缺少某些必要文件 

2. 问题现象：在使用ChatGui.print()打印聊天事件进行测试时游戏进程卡死、崩溃
   初步推测：代码逻辑中存在无限递归，需要先Disable插件再进行处理

3. 问题现象：直接使用Google Translate的Web链接时无法通过请求获取JSON数据
   初步推测：无法直接通过常规Web链接获取数据，需要通过其他接口

4. 问题现象：浮窗无法正常显示中文字符
   初步推测：Dalamud or 游戏客户端无法正常加载中文字符集

### 调试与解决
#### 问题1
- 尝试方案1：与修改命名前的项目文件对比，发现缺少插件的描述文件.json，复制粘贴到.dll文件所在文件夹 → [x] 成功

#### 问题2
- 尝试方案1：为第一次捕获的聊天事件打上标记（e.g. [TS]{text}），重复捕获时忽略（return）→ [x] 成功

#### 问题3
- 尝试方案1：使用旧版链接重写API逻辑
  (https://translate.googlapis.com/translate_a/single?client=gtx&sl=en&tl=zh-CN&d=t&q={encodeInput})→ [x] 成功

#### 问题4
- 尝试方案1：下载新的中文字符集并替换 → 失败
- 尝试方案2：查看API document，试图修改默认字体，导致游戏频繁崩溃 → 失败
- 尝试方案3：发现Dalamud的插件选择界面支持中文，说明问题更可能出在浮窗的逻辑定义上，遂删除所有修改字体代码，重新写逻辑，使用函数Text()而不是TextWrapped()，后者会试图为中文字符逐字扫描、自动换行，导致出错 → [x] 成功

### 关键代码片段
```C#
if(!string.IsNullOrEmpty(currentText))
    ImGui.Text(currenText); // 这代码我可能记一辈子，花了整整三个小时还是靠着灵光一闪突然顿悟的，服了
```